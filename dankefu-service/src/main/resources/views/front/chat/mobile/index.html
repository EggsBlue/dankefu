<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="full-screen" content="yes">
    <meta name="x5-fullscreen" content="true">
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="viewport" content="initial-scale=1, user-scalable=0, minimal-ui" charset="UTF-8">
    <link rel="stylesheet" href="${base}/assets/js/plugins/layui/css/layui.css">
    <link rel="stylesheet" href="${base}/assets/js/plugins/mescroll/mescroll.min.css">

    <title>在线客服</title>
    <style>
        body {
            /* border:1px solid black; */
            height: 100vh;
            font-size: 12px;
        }

        #appim {
            width: 100%;
            height: 100%;
            /* display: flex; */
            /* border:1px solid red; */
        }
        .message-warp {
            /* border: 2px solid red; */
            font-size: .40625rem;
            clear:both;
        }

        .message-warp .date-time,.tip {
            text-align: center;
            color: #b2c2cc;
            margin-top: .3125rem;
            clear: both;
            /* border: 1px solid black; */
        }
        .tip-border{
            border-bottom: 1px dashed #b2c2cc;
            margin-bottom: 10px;
        }

        .message-warp .agent-message {
            display: block;
            margin-bottom: .625rem;
            margin-left: .375rem;
            position: relative;
            margin-top: .3125rem;

            float: left;
        }

        .message-warp .agent-message .head-img {
            opacity: 0.9;
            /*background: #07c5ba;*/
            width: 1.125rem;
            height: 1.125rem;
            border-radius: 1.125rem;
            position: absolute;
            top: 0px;
        }

        .message-warp .agent-message .head-img img {
            display: inline;
            width: 1.125rem;
            height: 1.125rem;
        }

        .message-warp .agent-message .chat-msg-cont {
            padding: 0 1.5625rem;
            padding-right: 3.8625rem;
            /* float: left; */
        }

        .chat-msg-text {
            background: #f5f8fa;
            border: 0.5px solid #c8cfdc;
        }

        .chat-msg-text {
            display: inline-block;
            margin: 0;
            position: relative;
            padding: .25rem .475rem;
            border-radius: .15625rem;
            color: #545c69;
        }

        .message-warp .user-message {
            margin-right: 12px;
            color: #fff;
            /* border: 2px solid blue; */
            margin-bottom: .625rem;
            position: relative;
            margin-top: .3125rem;
            display: block;
            float: right;
        }

        .message-warp .user-message .head-img {
            right: 0;
            /* border: 1px solid black; */
            opacity: 0.9;
            background: #07c5ba;
            width: 1.125rem;
            height: 1.125rem;
            border-radius: 1.125rem;
            position: absolute;
            top: 0px;
        }

        .message-warp .user-message .head-img img {
            width: 1.125rem;
            height: 1.125rem;
            display: inline;
        }

        .message-warp .user-message .chat-msg-cont {
            padding: 0 1.5625rem;
            /* padding-right: 3.8625rem; */
        }

        #chatContent {
            width: 100%;
            /* border: 3px solid yellow; */
            outline: none;
            scroll-behavior: smooth;
            overflow-y: auto;
            display: block;
            flex: 1;
            overflow-y:scroll;
            margin-bottom: 70px;
        }

        *{
            box-sizing: border-box;
        }
        footer{
            width: 100%;
            /* border:1px solid red; */
            display: block;
            outline: none;
            float: left;
            /* position: absolute; */
            position:fixed;
            bottom: 0;
            left: 0;
            background-color: #eaedf3;

        }
        footer .more{
            /*background-image: url(${base}/assets/images/加.png);*/
            line-height: 1;
            speak: none;
            font-style: normal;
            font-weight: normal;
            font-variant: normal;
            text-transform: none;
        }
        footer .warp{
            position: relative;
            height: 2.5625rem;
            border-top: 0.5px solid #c8cfdc;
            margin:0;
        }

        footer .warp #send{
            position: absolute;
            right:8px;
            background: #07c5ba;
            top:.15625rem;
            font-size: 1.40625rem;
            height: 2.125rem;
            line-height: 1.125rem;
            color: #fff;
            border-radius: .15625rem;
            text-decoration:none;
            padding:8px 15px;
        }

        footer .warp .textarea{
            position: absolute;
            top: 4px;
            /* right:25%; */
            width: 75%;
        }
        footer .warp .textarea input{
            height: 2.125rem;
            padding: .25rem .25rem;
            width: 100%;
            border:0.5px solid #c8cfda;
        }
        footer #dankefu-Copyright{
            text-align: center;
            line-height: 5px;
            font-size: 16px;
            color:#9ba8ba;
            border-top: 0.5px solid #c8cfdc;
            padding-top: 8px;
            margin-bottom: 10px;
        }
        .msg-last{
            margin-bottom: 130px;
        }
        /*.warp,.chatWrap{*/
            /*height:50%;*/
        /*}*/
    </style>
</head>

<body>
    <div class="chatWrap " id="appim">
        <div class="warp mescroll" id="chatContent">
        </div>
        <!--<div class="message-warp">-->
        <!--<div class="date-time">以上是历史消息</div>-->
        <!--</div>-->
        <!--<div class="message-warp">-->
        <!--<div class="date-time">2018-08</div>-->
        <!--<div class="user-message">-->
        <!--<div class="head-img">-->
        <!--<img src="${base}/assets/mobile/images/head_visitor.png" alt="">-->
        <!--</div>-->
        <!--<div class="chat-msg-cont">-->
        <!--<div class="chat-msg-text">-->
        <!--你好，请问有什么可以帮助您的？-->
        <!--<br> **回复0可以转人工哦**-->
        <!--</div>-->
        <!--</div>-->
        <!--</div>-->
        <!--</div>-->
        <!--<div class="message-warp">-->
        <!--<div class="date-time">05-27 14:24</div>-->
        <!--<div class="agent-message">-->
        <!--<div class="head-img">-->
        <!--<img src="${base}/assets/mobile/images/head_visitor.png" alt="">-->
        <!--</div>-->
        <!--<div class="chat-msg-cont">-->
        <!--<div class="chat-msg-text">-->
        <!--你好，请问有什么可以帮助您的？-->
        <!--<br> **回复0可以转人工哦**-->
        <!--</div>-->
        <!--</div>-->
        <!--</div>-->
        <!--</div>-->
        <footer>
            <div class="warp">
                <i class="more"></i>
                <div class="textarea">
                    <input type="text" id="msgIn" placeholder="发送新消息">
                </div>
                <a  id="send">发送</a>
            </div>
            <div id="dankefu-Copyright">
                <i></i>
                <span>由蛋客服提供技术支持</span>
            </div>
        </footer>
    </div>
</body>
<script type="text/javascript" src="${base}/assets/js/jquery.min.js"></script>
<script type="text/javascript" src="${base}/assets/js/plugins/layui/layui.all.js"></script>
<script type="text/javascript" src="${base}/assets/js/reconnecting-websocket.js"></script>
<script type="text/javascript" src="${base}/assets/js/websocket/dankefu-types.js"></script>
<script type="text/javascript" src="${base}/assets/js/websocket/dankefu-tpls.js"></script>
<script type="text/javascript" src="${base}/assets/js/websocket/dankefu.js"></script>
<script type="text/javascript" src="${base}/assets/js/plugins/mescroll/mescroll.min.js"></script>


<!--<script id="waiting" type="text/html">-->
    <!--<div class="message-warp">-->
        <!--<div class="date-time">{{d.time}}</div>-->
        <!--<div class="agent-message">-->
            <!--<div class="head-img">-->
                <!--<img src="${base}/assets/mobile/images/head_visitor.png" alt="">-->
            <!--</div>-->
            <!--<div class="chat-msg-cont">-->
                <!--<div class="chat-msg-text">-->
                    <!--当前客服繁忙，正在为您排队中，您前面还有{{d.waitingCount}}个人-->
                <!--</div>-->
            <!--</div>-->
        <!--</div>-->
    <!--</div>-->
<!--</script>-->
<!--<script id="join" type="text/html">-->
    <!--<div class="message-warp">-->
        <!--<div class="date-time">{{d.time}}</div>-->
        <!--<div class="agent-message">-->
            <!--<div class="head-img">-->
                <!--<img src="${base}/assets/mobile/images/head_visitor.png" alt="">-->
            <!--</div>-->
            <!--<div class="chat-msg-cont">-->
                <!--<div class="chat-msg-text">-->
                   <!--{{d.msg}}-->
                <!--</div>-->
            <!--</div>-->
        <!--</div>-->
    <!--</div>-->
<!--</script>-->


<script id="msg_item" type="text/html">
    <div class="message-warp">
        <div class="date-time">{{d.prevTime || ''}}</div>
        <div class=" {{#  if(d.msgFrom == guest_id){  }}  user-message {{# }else{   }} agent-message  {{# } }}   ">
            <div class="head-img">
                <img src="{{d.icon || '${base}/assets/mobile/images/head_visitor.png'}}" alt="">
            </div>
            <div class="chat-msg-cont">
                <div class="chat-msg-text">
                    {{d.content||'-'}}
                </div>
            </div>
        </div>
    </div>
</script>

<script id="tips" type="text/html">
    <div class="message-warp">
        <div class="tip-border tip">{{d.msg}}</div>
    </div>
</script>


<script id="msg_list" type="text/html">
    {{#  layui.each(d.list, function(index, item){ }}
        <div class="message-warp">
            <div class="date-time">{{item.prevTime || ''}}</div>
            <div class="agent-message">
                <div class="head-img">
                    <img src="{{item.icon ||'${base}/assets/mobile/images/head_visitor.png' }}" alt="">
                </div>
                <div class="chat-msg-cont">
                    <div class="chat-msg-text">
                        {{item.content}}
                    </div>
                </div>
            </div>
        </div>
    {{#  }); }}
    {{#  if(d.list.length === 0){ }}
        无数据
    {{#  } }}
</script>


<script>
    // console.log('${@conf.get("websocket.port")}');
    // console.log('${@conf.get("websocket.ip")}');
    var ws;
    var guest_id = '${guest_id!}';
    var unitId = '${unitId!}';
    var laytpl;
    var start_time;
    var end_time;
    var servicer_id = "";  //当前客服标识
    var session_id = "";  //当前来访会话标识
    var source = "web_mobile";  //标识来源
    var page = 1;
    var pageSize = 20;
    var month = ""; //聊天记录月份记录
    var mescroll;   //下拉刷新组件
    var loadRecord = false;  //聊天记录是否加载完毕
    var ct = 0;
    var chatContentScrollTop = 0;


    $(function(){
        layui.use('laytpl', function(){
            laytpl = layui.laytpl;
        });
        start_time= new Date().getTime();
        initRecords();

        var t = setInterval(function(){
           if(loadRecord){
               initSocket();
               clearTimeout(t)
           }
        },10);

        $('#send').click(function(){
            sendMsg();
        });

        $("#msgIn").keydown(function(event){
            event=document.all?window.event:event;
            if((event.keyCode || event.which)==13){
                sendMsg();
            }
        });
    });

    function sendMsg(){
        var msg = $('#msgIn').val();
        if($.trim(msg) == '' ){
            layer.msg("请输入要发送的内容");
            return;
        }
        if(session_id == ''){
            return;
        }

        var packet = {};
        packet.action = type.S_REQ_RECEIVEMSG;
        packet.msgFrom = guest_id;
        packet.msgTo = servicer_id;
        packet.recordType = "chat";
        packet.msgType = "text";
        packet.prevTime = "";
        packet.content = msg;
        packet.unitId = unitId;
        packet.session_id = session_id;
        packet.source = source;
        var str = JSON.stringify(packet)

        console.log("send_plain："+str);
        ws.send(str);
        var receiveTpl = msg_item.innerHTML,chatContent = $('#chatContent');
        laytpl(receiveTpl).render(packet, function(html){
            $(chatContent).append( html );
        });
        var box = $('#chatContent')[0];
        box.scrollTop = box.scrollHeight;
        $('#msgIn').val('');
    }

    function reqService(){
        var packet = {
            action:type.C_REQ_SERVICE,
            guest_id:guest_id
        };
        var str = JSON.stringify(packet)
        console.log("请求服务....");
        ws.send(str);
    }

    function handleMsg(msgStr){
        var data = JSON.parse(msgStr);
        var action = data.action+"";
        if(data.body.session_id){
            session_id =  data.body.session_id;
        }
        switch (action){
            case type.C_RESP_RESTTIME:
                dankefu.c_handlers.resttime(data.body);
                break;
            case type.C_RESP_WAITING:
                dankefu.c_handlers.waiting(data.body);
                break;
            case type.C_RESP_JOIN:
                dankefu.c_handlers.join(data.body);
                break;
            case type.C_RESP_NOONESERVICER:
                dankefu.c_handlers.nooneservicer(data.body);
                break;
            case type.C_RESP_INVITINGMESSAGE:
                break;
            case type.C_RESP_RECEIVEMSG:
                dankefu.c_handlers.receiveMsg(data.body);
                break;
            default:
                console.error("illegal action: "+action);
        }

        end_time = new Date().getTime();
        console.log("process done :"+(end_time-start_time)+" ms");
    }


    function downCallback(){
        $.ajax({
            url:'${base}/front/chat/query',
            method:'post',
            data:{chatId:guest_id,servicer_id:servicer_id,month:month,offset_ct:ct},
            async:false,
            success:function(data){
                console.log(data);
                month = data.tableName;
                // alert(1);
                page++;
                if(data.data && data.data.list && data.data.list.length>0){
                    var chatContent = $('#chatContent');;
                    for(item of data.data.list){
                        var receiveTpl = msg_item.innerHTML;
                        var loadEl = $(chatContent).find('.mescroll-downwarp');
                        laytpl(receiveTpl).render(item, function(html){
                            $(loadEl).after(html);
                        });
                        // var msg_itemEl = $('.message-warp')[0];
                        // console.log(msg_itemEl);
                    }

                    if(page == 2){
                        var tipTpl = tips.innerHTML;
                        laytpl(tipTpl).render({msg:'以上为历史消息'}, function(html){
                            $(chatContent).append(html);
                        });
                        chatContent[0].scrollTop = chatContent[0].scrollHeight;
                    }


                    chatContent[0].scrollTop = 52*data.data.list.length;
                    // chatContentScrollTop = chatContent[0].scrollHeight;

                    console.log("结算后:"+chatContentScrollTop);

                    // chatContent[0].scrollTop = data.data.list.length * 55;
                    console.log(data.data.list);
                    var item = data.data.list[data.data.list.length-1];
                    console.log(ct);
                    ct = item.createTime;
                }

                loadRecord = true;
                console.log("聊天记录查询完毕...");
            },
            error:function(e){
                console.log(e)
                loadRecord = true;
            }
        });

        //
        //
        // for(var i = 0; i < 8; i++){
        //     j++;
        //     var packet = {};
        //     packet.action = type.S_REQ_RECEIVEMSG;
        //     packet.msgFrom = '111'
        //     packet.msgTo = '222';
        //     packet.recordType = "chat";
        //     packet.msgType = "text";
        //     packet.prevTime = "";
        //     packet.content = ''+j;
        //     packet.unitId = unitId;
        //     packet.session_id = '';
        //     packet.source = source;
        //     var str = JSON.stringify(packet)
        //
        //     // console.log("send_plain："+str);
        //     var receiveTpl = msg_item.innerHTML,chatContent = $('#chatContent').find('.mescroll-downwarp');
        //     laytpl(receiveTpl).render(packet, function(html){
        //         chatContent.after(html);
        //     });
        // }
        mescroll.endSuccess();
    }

    function initRecords(){
        mescroll = new MeScroll("chatContent", { //第一个参数"mescroll"对应上面布局结构div的id
            //如果您的下拉刷新是重置列表数据,那么down完全可以不用配置,具体用法参考第一个基础案例
            //解析: down.callback默认调用mescroll.resetUpScroll(),而resetUpScroll会将page.num=1,再触发up.callback
            use:true,
            offset:0,
            down: {
                callback: downCallback //下拉刷新的回调,别写成downCallback(),多了括号就自动执行方法了
            }
        });

        console.warn("initRecords结尾...");
    }



    function initSocket(){
        console.log("开始建立socket连接");
        //初始化websocket连接
        ws = new ReconnectingWebSocket('ws://${@conf.get("websocket.ip")}:${@conf.get("websocket.port")}?type=web_mobile&guest_id='+guest_id,null, {debug: true, reconnectInterval: 3000});

        ws.onopen = function(event){
            console.log("ws is open");
            reqService();

            end_time= new Date().getTime();
            console.log("init done: "+(end_time-start_time)+" ms");
        };

        ws.onerror = function(){
            console.log("ws is error");
        }

        ws.onclose = function(){
            console.log("ws is close");
        };

        ws.onmessage = function(event){
            console.log("ws recive message..");
            // console.log(event.data);
            start_time= new Date().getTime();
            //处理消息
            handleMsg(event.data);
        }
    }
</script>
</html>